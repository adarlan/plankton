#!/bin/bash
set -e

MAVEN_TAG=3.6-jdk-11
BASE_DIR=$PWD

buildEngine () {
    cd $BASE_DIR/engine
    docker run -it --rm \
        -u $(id -u $USER):$(id -g $USER) \
        -v /etc/passwd:/etc/passwd:ro \
        -v $HOME/.m2/repository:$HOME/.m2/repository \
        -v $PWD:/workspace \
        -w /workspace \
        --entrypoint "" \
        maven:$MAVEN_TAG \
        mvn install
}

buildRunner () {
    cd $BASE_DIR/runner
    docker run -it --rm \
        -u $(id -u $USER):$(id -g $USER) \
        -v /etc/passwd:/etc/passwd:ro \
        -v $HOME/.m2/repository:$HOME/.m2/repository \
        -v $PWD:/workspace \
        -w /workspace \
        --entrypoint "" \
        maven:$MAVEN_TAG \
        mvn install
    docker build -t adarlan/plankton .
    docker build -t adarlan/plankton:sandbox -f sandbox.Dockerfile .
}

pushImages () {
    docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD
    docker push adarlan/plankton
    docker push adarlan/plankton:sandbox
}

if [ "$1" = "" ]; then
    set -exu
    buildEngine && echo
    buildRunner

elif [ "$1" = "engine" ]; then
    set -exu
    buildEngine

elif [ "$1" = "runner" ]; then
    set -exu
    buildRunner

elif [ "$1" = "--push" ]; then
    set -exu
    buildEngine && echo
    buildRunner && echo
    pushImages
fi
