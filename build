#!/bin/bash
set -ex

MAVEN_TAG="3.6-jdk-11"

# build and install core-library jar
docker run -it --rm \
  -u $(id -u $USER):$(id -g $USER) \
  -v /etc/passwd:/etc/passwd:ro \
  -v $HOME/.m2/repository:$HOME/.m2/repository \
  -v $PWD/core-library:/workspace \
  -w /workspace \
  --entrypoint "" \
  maven:$MAVEN_TAG \
  mvn install

# build local-runner jar
docker run -it --rm \
  -u $(id -u $USER):$(id -g $USER) \
  -v /etc/passwd:/etc/passwd:ro \
  -v $HOME/.m2/repository:$HOME/.m2/repository \
  -v $PWD/local-runner:/workspace \
  -w /workspace \
  --entrypoint "" \
  maven:$MAVEN_TAG \
  mvn package

# build remote-runner jar
docker run -it --rm \
  -u $(id -u $USER):$(id -g $USER) \
  -v /etc/passwd:/etc/passwd:ro \
  -v $HOME/.m2/repository:$HOME/.m2/repository \
  -v $PWD/remote-runner:/workspace \
  -w /workspace \
  --entrypoint "" \
  maven:$MAVEN_TAG \
  mvn package

docker build -t dockerflow:local-runner local-runner
docker build -t dockerflow:remote-runner remote-runner
docker build -t dockerflow:remote-runner-sandbox remote-runner-sandbox
