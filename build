#!/bin/bash
set -e

buildJar () {
    docker run -it --rm \
        -u $(id -u $USER):$(id -g $USER) \
        -v /etc/passwd:/etc/passwd:ro \
        -v $HOME/.m2/repository:$HOME/.m2/repository \
        -v $PWD:/workspace \
        -w /workspace \
        --entrypoint "" \
        maven:3.6-jdk-11 \
        mvn install
}

buildImages () {
    docker build -t adarlan/plankton .
    docker build -t adarlan/plankton:sandbox -f sandbox.Dockerfile .
}

pushImages () {
    docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD
    docker push adarlan/plankton
    docker push adarlan/plankton:sandbox
}

if [ "$1" = "" ]; then
    set -exu
    buildJar && echo
    buildImages

elif [ "$1" = "jar" ]; then
    set -exu
    buildJar

elif [ "$1" = "images" ]; then
    set -exu
    buildImages

elif [ "$1" = "--push" ]; then
    set -exu
    buildJar && echo
    buildImages && echo
    pushImages
fi
