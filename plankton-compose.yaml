services:
  build_plankton_jar:
    image: maven:3.6-jdk-11
    entrypoint:
      - mvn package -DskipTests
    working_dir: /workspace
    volumes:
      - ./src:/workspace/src:ro
      - ./pom.xml:/workspace/pom.xml:ro
      - ./target:/workspace/target
      - .m2/repository:/root/.m2/repository

  build_plankton_image:
    depends_on: build_plankton_jar
    image: docker:20.10
    entrypoint:
      - docker build -t adarlan/plankton .
    working_dir: /workspace
    volumes:
      - ./Dockerfile:/workspace/Dockerfile
      - ./target:/workspace/target
      - /var/run/docker.sock:/var/run/docker.sock

  build_plankton_sandbox_image:
    image: docker:20.10
    entrypoint:
      - docker build -t adarlan/plankton:sandbox sandbox
    working_dir: /workspace
    volumes:
      - ./sandbox:/workspace/sandbox
      - /var/run/docker.sock:/var/run/docker.sock

  .test:
    image: adarlan/plankton
    command:
      - --spring.main.web-application-type=none
    working_dir: /workspace
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  test_saying-hello-world:
    extends: .test
    depends_on: build_plankton_image
    volumes:
      - ./examples/saying-hello-world:/workspace

  .push_image:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - plankton.env
    entrypoint:
      - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD
      - docker push $IMAGE

  push_plankton_image:
    extends: .push_image
    environment:
      - IMAGE=adarlan/plankton
    depends_on:
      - test_saying-hello-world

  push_plankton_sandbox_image:
    extends: .push_image
    environment:
      - IMAGE=adarlan/plankton:sandbox
    depends_on:
      - test_saying-hello-world
